<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plugin System - Test Suite</title>
    <link rel="stylesheet" href="import-ui.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: #f5f7fa;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .plugin-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 25px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .plugin-section h3 {
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .plugin-icon {
            font-size: 1.2em;
        }
        
        .plugin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .plugin-card {
            background: white;
            color: #2d3748;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #667eea;
        }
        
        .plugin-card h4 {
            margin-top: 0;
            color: #667eea;
        }
        
        .plugin-code {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            margin: 10px 0;
            border: 1px solid #4a5568;
        }
        
        .test-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 25px 0;
        }
        
        .test-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        
        .test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .test-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .plugin-status {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #28a745;
        }
        
        .plugin-registry {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .plugin-list {
            display: grid;
            gap: 10px;
            margin-top: 15px;
        }
        
        .plugin-item {
            background: white;
            padding: 10px 15px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .plugin-name {
            font-weight: 600;
            color: #2d3748;
        }
        
        .plugin-type {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .lifecycle-log {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .log-entry {
            padding: 3px 0;
            border-bottom: 1px solid #f1f3f4;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-init { color: #17a2b8; }
        .log-file { color: #28a745; }
        .log-transform { color: #6610f2; }
        .log-validate { color: #fd7e14; }
        .log-filter { color: #6f42c1; }
        .log-batch { color: #e83e8c; }
        .log-complete { color: #20c997; }
        .log-error { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Plugin System - Test Suite</h1>
            <p>Comprehensive testing for the ImportSDK plugin architecture</p>
        </div>

        <div class="plugin-section">
            <h3><span class="plugin-icon">üéØ</span> Plugin System Overview</h3>
            <p>The ImportSDK plugin system allows you to extend functionality at three levels:</p>
            <div class="plugin-grid">
                <div class="plugin-card">
                    <h4>üîß Field Plugins</h4>
                    <p>Transform and validate individual field values</p>
                    <div class="plugin-code">transform(value, fieldName, row, config)
validate(value, fieldName, row, config)</div>
                </div>
                <div class="plugin-card">
                    <h4>üìã Row Plugins</h4>
                    <p>Process entire rows with cross-field logic</p>
                    <div class="plugin-code">transform(transformedRow, originalRow, config)
validate(row, config)
filter(row, config)</div>
                </div>
                <div class="plugin-card">
                    <h4>üì¶ Batch Plugins</h4>
                    <p>Handle batch processing and API integration</p>
                    <div class="plugin-code">beforeSend(batch, sdk, config)
afterSend(result, batch, sdk, config)</div>
                </div>
            </div>
        </div>

        <div class="plugin-registry">
            <h3>üìã Plugin Registry</h3>
            <p>Currently registered plugins:</p>
            <div id="plugin-list" class="plugin-list">
                <div class="plugin-item">
                    <span class="plugin-name">No plugins registered</span>
                    <span class="plugin-type">-</span>
                </div>
            </div>
        </div>

        <div class="test-controls">
            <button class="test-btn" onclick="registerFieldPlugins()">
                <span>üîß</span> Register Field Plugins
            </button>
            <button class="test-btn" onclick="registerRowPlugins()">
                <span>üìã</span> Register Row Plugins
            </button>
            <button class="test-btn" onclick="registerBatchPlugins()">
                <span>üì¶</span> Register Batch Plugins
            </button>
            <button class="test-btn" onclick="registerLifecyclePlugins()">
                <span>üîÑ</span> Register Lifecycle Plugins
            </button>
            <button class="test-btn" onclick="createTestData()">
                <span>üìù</span> Create Test Data
            </button>
            <button class="test-btn" onclick="runPluginTest()">
                <span>üöÄ</span> Run Plugin Test
            </button>
            <button class="test-btn" onclick="clearAllPlugins()">
                <span>üóëÔ∏è</span> Clear All Plugins
            </button>
            <button class="test-btn" onclick="showPluginDocs()">
                <span>üìö</span> Show Plugin Examples
            </button>
        </div>

        <div id="plugin-status" class="plugin-status" style="display:none;">
            <h4>Plugin Status</h4>
            <div id="status-message"></div>
        </div>

        <div class="plugin-registry">
            <h3>üîÑ Plugin Lifecycle Log</h3>
            <p>Real-time plugin execution logging:</p>
            <div id="lifecycle-log" class="lifecycle-log">
                <div class="log-entry log-init">Ready to test plugins...</div>
            </div>
        </div>

        <div id="import-container"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="import-sdk.js"></script>

    <!-- Propietary plugin -->
    <script src="import-sdk-contenant.js"></script>
    
    <script>
        let currentSDK = null;
        let lifecycleLog = [];

        function logLifecycle(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = `[${timestamp}] ${message}`;
            lifecycleLog.push({ timestamp, message, type });
            
            const logContainer = document.getElementById('lifecycle-log');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = entry;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            console.log(`[Plugin] ${entry}`);
        }

        function updatePluginRegistry() {
            const plugins = ImportSDK.getPlugins();
            const listContainer = document.getElementById('plugin-list');
            
            if (plugins.length === 0) {
                listContainer.innerHTML = `
                    <div class="plugin-item">
                        <span class="plugin-name">No plugins registered</span>
                        <span class="plugin-type">-</span>
                    </div>
                `;
                return;
            }
            
            listContainer.innerHTML = plugins.map(plugin => `
                <div class="plugin-item">
                    <span class="plugin-name">${plugin.name}</span>
                    <span class="plugin-type">${plugin.type}</span>
                </div>
            `).join('');
        }

        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('plugin-status');
            const messageDiv = document.getElementById('status-message');
            
            statusDiv.style.display = 'block';
            messageDiv.textContent = message;
            statusDiv.style.borderLeftColor = type === 'success' ? '#28a745' : '#dc3545';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Field Plugins
        function registerFieldPlugins() {
            try {
                // Date Normalizer Plugin
                ImportSDK.use({
                    name: 'dateNormalizer',
                    type: 'field',
                    transform(value, fieldName, row, config) {
                        logLifecycle(`DateNormalizer: Processing field '${fieldName}' with value '${value}'`, 'transform');
                        
                        if (config.dateFields.some(field => fieldName.toLowerCase().includes(field.toLowerCase()))) {
                            try {
                                const date = new Date(value);
                                if (!isNaN(date.getTime())) {
                                    const isoDate = date.toISOString();
                                    logLifecycle(`DateNormalizer: Converted '${value}' to '${isoDate}'`, 'transform');
                                    return isoDate;
                                }
                            } catch (e) {
                                logLifecycle(`DateNormalizer: Failed to parse date '${value}'`, 'error');
                            }
                        }
                        return value;
                    },
                    validate(value, fieldName, row, config) {
                        if (config.dateFields.some(field => fieldName.toLowerCase().includes(field.toLowerCase()))) {
                            if (value && !value.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3}Z$/)) {
                                logLifecycle(`DateNormalizer: Invalid date format '${value}' for field '${fieldName}'`, 'validate');
                                return { isValid: false, error: `Invalid date format in ${fieldName}` };
                            }
                        }
                        return { isValid: true };
                    },
                    config: {
                        dateFields: ['date', 'created', 'updated', 'inspection']
                    }
                });

                // Number Formatter Plugin
                ImportSDK.use({
                    name: 'numberFormatter',
                    type: 'field',
                    transform(value, fieldName, row, config) {
                        if (config.numberFields.includes(fieldName)) {
                            logLifecycle(`NumberFormatter: Processing '${fieldName}': '${value}'`, 'transform');
                            const num = parseFloat(String(value).replace(/[^\d.-]/g, ''));
                            if (!isNaN(num)) {
                                logLifecycle(`NumberFormatter: Converted '${value}' to ${num}`, 'transform');
                                return num;
                            }
                        }
                        return value;
                    },
                    validate(value, fieldName, row, config) {
                        if (config.numberFields.includes(fieldName)) {
                            if (value !== null && value !== undefined && value !== '' && isNaN(Number(value))) {
                                logLifecycle(`NumberFormatter: Invalid number '${value}' for field '${fieldName}'`, 'validate');
                                return { isValid: false, error: `Invalid number format in ${fieldName}` };
                            }
                        }
                        return { isValid: true };
                    },
                    config: {
                        numberFields: ['latitude', 'longitude', 'price', 'quantity']
                    }
                });

                updatePluginRegistry();
                showStatus('Field plugins registered successfully!');
                logLifecycle('Field plugins (dateNormalizer, numberFormatter) registered', 'init');
            } catch (error) {
                showStatus(`Error registering field plugins: ${error.message}`, 'error');
                logLifecycle(`Error registering field plugins: ${error.message}`, 'error');
            }
        }

        // Row Plugins
        function registerRowPlugins() {
            try {
                // Coordinate Validator Plugin
                ImportSDK.use({
                    name: 'coordinateValidator',
                    type: 'row',
                    validate(row, config) {
                        const lat = parseFloat(row.latitude);
                        const lng = parseFloat(row.longitude);
                        
                        logLifecycle(`CoordinateValidator: Checking coordinates (${lat}, ${lng})`, 'validate');
                        
                        if (!isNaN(lat) && !isNaN(lng)) {
                            if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                                logLifecycle(`CoordinateValidator: Invalid coordinates (${lat}, ${lng})`, 'validate');
                                return { isValid: false, error: 'GPS coordinates out of valid range' };
                            }
                        }
                        return { isValid: true };
                    },
                    filter(row, config) {
                        if (!row.latitude || !row.longitude) {
                            logLifecycle(`CoordinateValidator: Filtering row - missing coordinates`, 'filter');
                            return { passed: false, reason: 'Missing GPS coordinates' };
                        }
                        return { passed: true };
                    }
                });

                // Data Enrichment Plugin
                ImportSDK.use({
                    name: 'dataEnricher',
                    type: 'row',
                    transform(row, originalRow, config) {
                        logLifecycle(`DataEnricher: Enriching row for tank ${row.tankNumber}`, 'transform');
                        
                        // Add computed fields
                        if (row.latitude && row.longitude) {
                            row.coordinates = `${row.latitude},${row.longitude}`;
                            row.region = getRegion(parseFloat(row.latitude), parseFloat(row.longitude));
                            logLifecycle(`DataEnricher: Added coordinates and region (${row.region})`, 'transform');
                        }
                        
                        // Add timestamp
                        row._enrichedAt = new Date().toISOString();
                        
                        return row;
                    }
                });

                updatePluginRegistry();
                showStatus('Row plugins registered successfully!');
                logLifecycle('Row plugins (coordinateValidator, dataEnricher) registered', 'init');
            } catch (error) {
                showStatus(`Error registering row plugins: ${error.message}`, 'error');
                logLifecycle(`Error registering row plugins: ${error.message}`, 'error');
            }
        }

        // Batch Plugins
        function registerBatchPlugins() {
            try {
                // Audit Logger Plugin
                ImportSDK.use({
                    name: 'auditLogger',
                    type: 'batch',
                    beforeSend(batch, sdk, config) {
                        logLifecycle(`AuditLogger: Processing batch of ${batch.length} records`, 'batch');
                        
                        return batch.map(record => ({
                            ...record,
                            _batchId: config.batchId || `batch_${Date.now()}`,
                            _processedAt: new Date().toISOString(),
                            _batchSize: batch.length
                        }));
                    },
                    afterSend(result, batch, sdk, config) {
                        logLifecycle(`AuditLogger: Batch complete - ${result.success} success, ${result.errors.length} errors`, 'batch');
                        
                        // Add audit metadata
                        result.auditInfo = {
                            batchId: config.batchId || `batch_${Date.now()}`,
                            processedAt: new Date().toISOString(),
                            batchSize: batch.length
                        };
                        
                        return result;
                    },
                    config: {
                        batchId: `test_batch_${Date.now()}`
                    }
                });

                // Batch Optimizer Plugin
                ImportSDK.use({
                    name: 'batchOptimizer',
                    type: 'batch',
                    beforeSend(batch, sdk, config) {
                        logLifecycle(`BatchOptimizer: Optimizing batch of ${batch.length} records`, 'batch');
                        
                        // Sort by tank number for database optimization
                        const sorted = [...batch].sort((a, b) => {
                            if (a.tankNumber && b.tankNumber) {
                                return a.tankNumber.localeCompare(b.tankNumber);
                            }
                            return 0;
                        });
                        
                        logLifecycle(`BatchOptimizer: Sorted batch by tankNumber`, 'batch');
                        return sorted;
                    }
                });

                updatePluginRegistry();
                showStatus('Batch plugins registered successfully!');
                logLifecycle('Batch plugins (auditLogger, batchOptimizer) registered', 'init');
            } catch (error) {
                showStatus(`Error registering batch plugins: ${error.message}`, 'error');
                logLifecycle(`Error registering batch plugins: ${error.message}`, 'error');
            }
        }

        // Lifecycle Plugins
        function registerLifecyclePlugins() {
            try {
                // Lifecycle Monitor Plugin
                ImportSDK.use({
                    name: 'lifecycleMonitor',
                    type: 'row', // Can be any type, we're only using lifecycle hooks
                    onInit(sdk, config) {
                        logLifecycle('LifecycleMonitor: SDK initialized', 'init');
                    },
                    onFileSelect(file, sdk, config) {
                        logLifecycle(`LifecycleMonitor: File selected - ${file.name} (${(file.size / 1024).toFixed(2)} KB)`, 'file');
                    },
                    onComplete(stats, sdk, config) {
                        logLifecycle(`LifecycleMonitor: Import complete - ${stats.successCount} success, ${stats.errorCount} errors, ${stats.totalCount} total`, 'complete');
                    }
                });

                updatePluginRegistry();
                showStatus('Lifecycle plugins registered successfully!');
                logLifecycle('Lifecycle plugin (lifecycleMonitor) registered', 'init');
            } catch (error) {
                showStatus(`Error registering lifecycle plugins: ${error.message}`, 'error');
                logLifecycle(`Error registering lifecycle plugins: ${error.message}`, 'error');
            }
        }

        function getRegion(lat, lng) {
            // Simple region detection for demo
            if (lat > 45) return 'North';
            if (lat < 35) return 'South';
            if (lng < 0) return 'West';
            return 'East';
        }

        function createTestData() {
            const testCsvData = `tankNumber,city,latitude,longitude,inspectionDate,price
TANK_001,Paris,48.8566,2.3522,2024-01-15,1500.50
TANK_002,London,51.5074,-0.1278,15/01/2024,$2,300.75
TANK_003,InvalidCoord,999.0000,-999.0000,invalid-date,not-a-number
TANK_004,,48.8566,2.3522,2024-01-20,1200.00
TANK_005,Berlin,52.5200,13.4050,2024/01/25,1800.90`;

            const blob = new Blob([testCsvData], { type: 'text/csv' });
            const file = new File([blob], 'plugin-test.csv', { type: 'text/csv' });
            
            if (currentSDK) {
                currentSDK.handleFileSelect(file);
                showStatus('Test CSV data created and loaded!');
                logLifecycle('Test CSV data created with various data quality issues', 'file');
            } else {
                showStatus('Please run plugin test first to initialize SDK', 'error');
            }
        }

        function runPluginTest() {
            const container = document.getElementById('import-container');
            container.innerHTML = '';
            
            currentSDK = ImportSDK.init(container, {
                apiEndpoint: 'http://localhost:3011/geored/bin/service/import',
                chunkSize: 3,
                resultExport: ['success', 'errors', 'logs'],
                
                onProgress: (stats) => {
                    logLifecycle(`Progress: ${stats.successCount} success, ${stats.errorCount} errors`, 'info');
                },
                
                onComplete: (stats) => {
                    showStatus(`Import test complete! Success: ${stats.successCount}, Errors: ${stats.errorCount}`);
                }
            });
            
            showStatus('SDK initialized with plugins. Use "Create Test Data" to load test CSV.');
            logLifecycle('SDK initialized for plugin testing', 'init');
        }

        function clearAllPlugins() {
            ImportSDK.clearPlugins();
            updatePluginRegistry();
            showStatus('All plugins cleared!');
            logLifecycle('All plugins cleared from registry', 'init');
            
            // Clear log
            document.getElementById('lifecycle-log').innerHTML = '<div class="log-entry log-init">Plugins cleared - ready for new tests...</div>';
            lifecycleLog = [];
        }

        function showPluginDocs() {
            const docs = `
üìö Plugin Development Examples:

üîß FIELD PLUGIN EXAMPLE:
ImportSDK.use({
    name: 'myFieldPlugin',
    type: 'field',
    transform(value, fieldName, row, config) {
        // Transform field value
        return transformedValue;
    },
    validate(value, fieldName, row, config) {
        // Return: { isValid: boolean, error?: string }
        return { isValid: true };
    },
    config: { /* plugin config */ }
});

üìã ROW PLUGIN EXAMPLE:
ImportSDK.use({
    name: 'myRowPlugin',
    type: 'row',
    transform(transformedRow, originalRow, config) {
        // Modify row
        return modifiedRow;
    },
    validate(row, config) {
        // Cross-field validation
        return { isValid: true };
    },
    filter(row, config) {
        // Filter logic
        return { passed: true };
    }
});

üì¶ BATCH PLUGIN EXAMPLE:
ImportSDK.use({
    name: 'myBatchPlugin',
    type: 'batch',
    beforeSend(batch, sdk, config) {
        // Process before API call
        return modifiedBatch;
    },
    afterSend(result, batch, sdk, config) {
        // Process API response
        return modifiedResult;
    }
});

üîÑ LIFECYCLE HOOKS:
{
    onInit(sdk, config) { /* SDK initialized */ },
    onFileSelect(file, sdk, config) { /* File selected */ },
    onComplete(stats, sdk, config) { /* Import complete */ }
}
            `.trim();
            
            alert(docs);
            logLifecycle('Plugin documentation displayed', 'info');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updatePluginRegistry();
            showStatus('Plugin Test Suite Ready! Register some plugins to get started.');
            logLifecycle('Plugin test suite initialized', 'init');
        });
    </script>
</body>
</html>