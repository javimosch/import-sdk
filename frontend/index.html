<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Import SDK Demo</title>
    <link rel="stylesheet" href="import-ui.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .demo-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .demo-header h1 {
            color: #2d3748;
            margin: 0 0 10px 0;
        }

        .demo-header p {
            color: #718096;
            margin: 0;
        }
    </style>
</head>

<body>
    <div class="demo-header">
        <h1>Import SDK Demo</h1>
        <p>Reusable CSV Import Library</p>
    </div>

    <!-- SDK will be injected here -->
    <div id="import-container"></div>

    <script src="import-sdk.js"></script>
    <script src="import-sdk-contenant.js"></script>
    <script>
        // Initialize the SDK with configuration
        ImportSDK.init(document.getElementById('import-container'), {
            // API Configuration
            apiEndpoint: 'http://localhost:3011/geored/bin/service/import',
            chunkSize: 100,
            updateByTankNumber: false,

            // Enable metrics backend
            metricsBackend: {
                enabled: true,
                baseURL: 'http://localhost:3012',
                includeProgress: true
            },

            // Multiple File Mappings - Auto-selects based on filename
            fileMappings: [
                {
                    name: 'Standard Format',
                    pattern: /test\.csv$/,
                    fieldMapping: {},  // No mapping needed
                    transformers: {
                        typeId: (value) => parseInt(value) || null,
                        latitude: (value) => parseFloat(value) || null,
                        longitude: (value) => parseFloat(value) || null
                    }
                },
                {
                    name: 'Custom Format',
                    pattern: /test2\.csv$/,
                    fieldMapping: {
                        'Tank ID': 'tankNumber',
                        'Type': 'typeId',
                        'Location': 'city',
                        'Lat': 'latitude',
                        'Long': 'longitude'
                    },
                    transformers: {
                        typeId: (value) => parseInt(value) || null,
                        latitude: (value) => parseFloat(value) || null,
                        longitude: (value) => parseFloat(value) || null
                    },
                    validate: {
                        latitude: [(v) => !!v, "Latitude is required"],
                        tankNumber: [(v) => !!v, "Tank Number is required"]
                    }
                }
            ],
            // Internationalization (i18n)
            locale: 'fr', // Change to 'fr' to test French
            translations: {
                fr: {
                    uploadPrompt: "Cliquez pour télécharger ou glissez-déposez",
                    uploadHint: "Fichiers CSV uniquement",
                    checkFile: "Vérifier le fichier",
                    startImport: "Démarrer l'importation",
                    importing: "Importation...",
                    checking: "Vérification...",
                    progressTitle: "Progression",
                    importProgress: "Progression de l'importation",
                    validationProgress: "Progression de la validation",
                    success: "Succès",
                    errors: "Erreurs",
                    total: "Total",
                    logs: "Journaux",
                    clearLogs: "Effacer",
                    ready: "Prêt à démarrer...",
                    fileSelected: "Fichier sélectionné : {filename} ({size} KB){mapping}",
                    mappingInfo: " (Cartographie : {name})",
                    fileRemoved: "Fichier supprimé.",
                    logsCleared: "Journaux effacés...",
                    parsingComplete: "Analyse terminée. Finalisation...",
                    importFinished: "Importation terminée.",
                    validationFinished: "Validation terminée.",
                    errorCsvOnly: "Veuillez télécharger un fichier CSV.",
                    usingMapping: "Utilisation de la cartographie : {name}",
                    parsingError: "Erreur d'analyse : {message}",
                    validationError: "Erreur de validation : {error}",
                    networkError: "Erreur réseau : {message}",
                    serverError: "Erreur serveur : {status} {statusText}",
                    batchValidationFailed: "Échec de la validation du lot : {status}",
                    handlerError: "Erreur du gestionnaire : {message}",
                    invalidHandlerResponse: "Réponse invalide du gestionnaire, utilisation des valeurs par défaut",
                    sendHandlerError: "Erreur du gestionnaire d'envoi : {message}"
                }
            },



            // Fallback mapping (if no pattern matches)
            fieldMapping: {},
            transformers: {},

            // Custom Send Handler (optional)
            // Uncomment to use custom send logic instead of default fetch
            /*
            sendHandler: async (batch, config) => {
                // Example: Use your own API wrapper
                console.log('Sending batch:', batch);
                
                // Simulate API call
                const response = await fetch(config.apiEndpoint, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        // Add custom headers here
                        // 'Authorization': 'Bearer YOUR_TOKEN'
                    },
                    body: JSON.stringify({
                        bins: batch,
                        updateByTankNumber: config.updateByTankNumber
                    })
                });
    
                const data = await response.json();
                
                // Transform to SDK format
                return {
                    success: data.bins?.filter(b => !b.error).length || 0,
                    errors: data.bins?.filter(b => b.error).map(b => ({
                        message: b.errorMessage,
                        tankNumber: b.bin?.tankNumber,
                        data: b
                    })) || []
                };
            },
            */

            // Callbacks (optional)
            onProgress: (stats) => {
                console.log('Progress:', stats);
            },
            onComplete: (result) => {
                console.log('Import complete:', result);
                alert(`Import finished!\nSuccess: ${result.successCount}\nErrors: ${result.errorCount}`);
            },
            onError: (error) => {
                console.error('Import error:', error);
            }
        });
    </script>

    <!-- Other demos section -->
    <div
        style="margin-top: 60px; padding: 40px 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h2 style="color: #2d3748; margin-bottom: 20px; text-align: center;">Other demos</h2>
        <div
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; max-width: 1200px; margin: 0 auto;">
            <a href="test-concurrency.html"
                style="display: block; padding: 12px 16px; background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 6px; text-decoration: none; color: #2d3748; transition: all 0.2s;">Concurrency
                Test</a>
            <a href="test-csvNormalization.html"
                style="display: block; padding: 12px 16px; background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 6px; text-decoration: none; color: #2d3748; transition: all 0.2s;">CSV
                Normalization</a>
            <a href="test-export-fix.html"
                style="display: block; padding: 12px 16px; background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 6px; text-decoration: none; color: #2d3748; transition: all 0.2s;">Export
                Fix</a>
            <a href="test-export.html"
                style="display: block; padding: 12px 16px; background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 6px; text-decoration: none; color: #2d3748; transition: all 0.2s;">Export</a>
            <a href="test-filters.html"
                style="display: block; padding: 12px 16px; background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 6px; text-decoration: none; color: #2d3748; transition: all 0.2s;">Filters</a>
            <a href="test-headers.html"
                style="display: block; padding: 12px 16px; background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 6px; text-decoration: none; color: #2d3748; transition: all 0.2s;">Headers</a>
            <a href="test-i18n.html"
                style="display: block; padding: 12px 16px; background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 6px; text-decoration: none; color: #2d3748; transition: all 0.2s;">Internationalization</a>
            <a href="test-isoprod.html"
                style="display: block; padding: 12px 16px; background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 6px; text-decoration: none; color: #2d3748; transition: all 0.2s;">ISO
                Production</a>
            <a href="test-metrics.html"
                style="display: block; padding: 12px 16px; background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 6px; text-decoration: none; color: #2d3748; transition: all 0.2s;">Metrics</a>
            <a href="test-plugins.html"
                style="display: block; padding: 12px 16px; background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 6px; text-decoration: none; color: #2d3748; transition: all 0.2s;">Plugins</a>
            <a href="test-sendHandler.html"
                style="display: block; padding: 12px 16px; background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 6px; text-decoration: none; color: #2d3748; transition: all 0.2s;">Send
                Handler</a>
            <a href="test-simulated.html"
                style="display: block; padding: 12px 16px; background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 6px; text-decoration: none; color: #2d3748; transition: all 0.2s;">Simulated
                Generic API</a>
            <a href="test-tools-plugins.html"
                style="display: block; padding: 12px 16px; background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 6px; text-decoration: none; color: #2d3748; transition: all 0.2s;">Tools
                Plugins</a>
            <a href="test-v2-plugins.html"
                style="display: block; padding: 12px 16px; background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 6px; text-decoration: none; color: #2d3748; transition: all 0.2s;">V2
                Plugins</a>
            <a href="test-validation.html"
                style="display: block; padding: 12px 16px; background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 6px; text-decoration: none; color: #2d3748; transition: all 0.2s;">Validation</a>
            <a href="test-apiv3iso.html"
                style="display: block; padding: 12px 16px; background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 6px; text-decoration: none; color: #2d3748; transition: all 0.2s;">APIV3-Contenant
                (Propietary)</a>
            <a href="test-validation-demo.html"
                style="display: block; padding: 12px 16px; background: #e6fffa; border: 1px solid #b2f5ea; border-radius: 6px; text-decoration: none; color: #234e52; transition: all 0.2s; font-weight: bold;">✨
                New: Validation & Flow</a>
            <a href="test-editor.html"
                style="display: block; padding: 12px 16px; background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 6px; text-decoration: none; color: #2d3748; transition: all 0.2s;">Test
                Editor</a>
        </div>
        <style>
            .demo-links a:hover {
                background: #edf2f7 !important;
                transform: translateY(-1px);
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
        </style>
    </div>
</body>

</html>